<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
<script src="https://unpkg.com/konva@8.4.2/konva.min.js"></script>
<script src="https://unpkg.com/vue@3"></script>

<title>diagram-maker - Draw Markov chain</title>
<style>

html, body {
	margin: 0;
	padding: 0;
	top: 0;
	left: 0;
	position: absolute;
}

#app {
	margin: 0;
	padding: 0;
	/* overflow: hidden; */
	background-color: white;
	display: flex;
}

</style>
</head>
<body>

<div id="app">
	<div :style="sideBarStyle">
		<div>
			<button @click="handleAddVertex">Add Vertex</button>
			<button @click="handleAddEdge">Add Edge</button>
			<button @click="handleAddText">Add Text</button>
			<button @click="handleCopyObject" title="Create duplicate of selected object">Copy Object</button>
			<button @click="handleToggleControlObjects" title="Toggle Control Objects">Toggle Control Objects</button>
		</div>
		<input type="text" v-model="inputText">
		<div>
			TODO: edit object property....
		</div>
	</div>
	<div :style="mainStageStyle">
		<div ref="konvaContainerElement"></div>
	</div>
</div>

<script>

const MathJaxSvgRenderOptions = {
	em: 16,
	ex: 8,
	containerWidth: 579,
	display: true,
	scale: 1,
	lineWidth: 1000000
};

const XmlHeader = '<' + '?xml version="1.0" encoding="UTF-8" standalone="no" ?' + '>\n';

const app = Vue.createApp({
	data() {
		return ({
			sideBarWidth: 200,
			konvaStage: null,
			konvaLayer: null,
			inputText: '\\frac{\\pi}{2}', // default
		});
	},
	computed: {
		mainStageStyle() {
			return {
				//flex: ('50%'),
				width: (window.innerWidth - this.sideBarWidth - 10) + 'px',
				border: '1px solid black',
			};
		},
		sideBarStyle() {
			return {
				//flex: (100 - this.stageWidthPercentage) + '%',
				width: this.sideBarWidth + 'px',
				border: '1px solid black',
			};
		},
	},
	methods: {
		initKonva() {
			let konvaContainerWidth = window.innerWidth - this.sideBarWidth - 10;
			let konvaContainerHeight = window.innerHeight;
			let konvaContainerElement = this.$refs.konvaContainerElement;
			let stage = new Konva.Stage({
				container: konvaContainerElement,
				width: konvaContainerWidth,
				height: konvaContainerHeight,
			});
			let layer = new Konva.Layer();
			stage.add(layer);
			this.konvaStage = stage;
			this.konvaLayer = layer;
		},
		handleAddVertex() {
			var vertex = new Konva.Circle({
				radius: 40,
				fill: null,
				stroke: 'black',
				strokeWidth: 1,
				draggable: true,
			});
			this.konvaLayer.add(vertex);
		},
		handleAddEdge() {
			var stage = this.konvaStage;
			var layer = this.konvaLayer;
			function buildAnchor(x, y) {
				var anchor = new Konva.Circle({
					x: x,
					y: y,
					radius: 5,
					stroke: 'blue',
					fill: null,
					name: 'bezierControlObject',
					strokeWidth: 1,
					draggable: true,
				});
				layer.add(anchor);
				// add hover styling
				anchor.on('mouseover', function () {
					document.body.style.cursor = 'pointer';
					this.strokeWidth(4);
				});
				anchor.on('mouseout', function () {
					document.body.style.cursor = 'default';
					this.strokeWidth(2);
				});
				anchor.on('dragmove', function () {
					updateDottedLines();
				});
				return anchor;
			}
			function updateDottedLines() {
				var b = bezier;
				var bezierLinePath = layer.findOne('#bezierLinePath');
				bezierLinePath.points([
					b.start.x(),
					b.start.y(),
					b.control1.x(),
					b.control1.y(),
					b.control2.x(),
					b.control2.y(),
					b.end.x(),
					b.end.y(),
				]);
			}
			var bezierLine = new Konva.Shape({
				stroke: 'black',
				strokeWidth: 1,
				pointerLength: 10,
				pointerWidth: 10,
				sceneFunc: (ctx, shape) => {
					ctx.beginPath();
					ctx.moveTo(bezier.start.x(), bezier.start.y());
					ctx.bezierCurveTo(
						bezier.control1.x(),
						bezier.control1.y(),
						bezier.control2.x(),
						bezier.control2.y(),
						bezier.end.x(),
						bezier.end.y()
					);
					ctx.fillStrokeShape(shape);
					// draw arrow pointer here:
					var PI2 = Math.PI * 2;
					var dx = bezier.end.x() - bezier.control2.x();
					var dy = bezier.end.y() - bezier.control2.y();
					//var dy = points[3] - points[1];
					var radians = (Math.atan2(dy, dx) + PI2) % PI2;
					var length = shape.getAttr('pointerLength');
					var width = shape.getAttr('pointerWidth');
					// draw pointer
					ctx.save();
					ctx.beginPath();
					ctx.translate(bezier.end.x(), bezier.end.y());
					ctx.rotate(radians);
					ctx.moveTo(0, 0);
					ctx.lineTo(-length, width / 2);
					ctx.moveTo(0, 0);
					ctx.lineTo(-length, -width / 2);
					ctx.restore();
					ctx.fillStrokeShape(shape);
				},
			});
			layer.add(bezierLine);
			var bezierLinePath = new Konva.Line({
				dash: [10, 10, 0, 10],
				strokeWidth: 1,
				stroke: 'blue',
				lineCap: 'round',
				id: 'bezierLinePath',
				name: 'bezierControlObject',
				opacity: 0.95,
				points: [0, 0],
			});
			layer.add(bezierLinePath);
			var bezier = {
				start: buildAnchor(280, 20),
				control1: buildAnchor(530, 40),
				control2: buildAnchor(480, 150),
				end: buildAnchor(300, 150),
			};
			updateDottedLines();
		},
		handleAddText() {
			let el = MathJax.tex2svg(this.inputText, MathJaxSvgRenderOptions);
			console.log(el.firstChild);
			let svg = el.firstChild;
			svg.removeAttribute('style');
			svg.removeAttribute('focusable');
			svg.removeAttribute('role');
			let svgString = (XmlHeader + svg.outerHTML);
			let image = new Image();
			image.src = 'data:image/svg+xml;base64,' + window.btoa(svgString);
			console.log(image);
			let konvaImage = new Konva.Image({
				image: image,
				x: 200,
				//width: 150,
				//height: 150,
				draggable: true,
			});
			this.konvaLayer.add(konvaImage);
		},
		handleCopyObject() { },  // TODO
		handleToggleControlObjects() {
			var controlObjects = this.konvaStage.find('.bezierControlObject');
			if (this.isControlObjectsVisible) {
				controlObjects.forEach(function (shape) {
					shape.hide();
				});
			} else {
				controlObjects.forEach(function (shape) {
					shape.show();
				});
			}
			this.isControlObjectsVisible = !this.isControlObjectsVisible;
		}
	},
	mounted() {
		this.initKonva();
	}
});

app.mount('#app');
</script>
</body>
</html>
